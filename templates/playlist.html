{% extends "base.html" %}
{% load static %}
{% block extra_head %}
    <link rel="stylesheet" href="{% static "css/playlist.css" %}"/>
    <title>Spotifi | {{ playlist.name }}</title>
    <script src="{% static "jquery-3.6.1.min.js"%}"></script>
{% endblock %}
{% block content %}
    <div class="info_playlist">
        <img class="image_playlist" src="{{ playlist.image_playlist.url }}">
        <div>
            <h1>{{ playlist.name }}</h1>
            <h2>{{ playlist.submitter }}</h2>
        </div>
    </div>
    <div class="info-music_list_class">
    <div class="info-music_list">
        <div id="decal_1"></div>
        <div id="decal_2"></div>
        <p id="titre_music_list">#title</p>
        <p id="titre_music_list">#artist</p>
        <p id="titre_music_list">#album</p>
    </div>
    </div>
    <hr id="hr_top">
    <div class="music_list_container">
    <ul class="music_list">
        {% for music in object.music.all %}
            <li id="music_case">
                <button class="play_pause" onclick="playAndPause('audio_{{ music.id }}')">
                    <svg class="btn_play" width="30px" height="30px" viewBox="0 0 24 24" fill="#ffffff" xmlns="http://www.w3.org/2000/svg">
                        <path style="fill:#FFFFFF;" d="M17.2839 11.134C17.9506 11.5189 17.9506 12.4811 17.2839 12.866L6.71601 18.9674C6.04934 19.3523 5.21601 18.8712 5.21601 18.1014L5.21601 5.8986C5.21601 5.1288 6.04934 4.64768 6.71601 5.03258L17.2839 11.134Z" fill="#000000"/>
                    </svg>
                    <svg class="btn_pause" width="30px" height="30px" viewBox="0 0 24 24" fill="#ffffff" xmlns="http://www.w3.org/2000/svg">
                        <path style="fill:#FFFFFF;" d="M8.5 7V18" stroke="#FFFFFF" stroke-width="3" stroke-linecap="round"/>
                        <path style="fill:#FFFFFF;" d="M15.5 7V12.5V18" stroke="#FFFFFF" stroke-width="3" stroke-linecap="round"/>
                    </svg>

                    <img id="cover_music" class="cover_music_playlist" src="{{ music.album.cover.url }}">
                    <p id="title_music" class="title_music_playlist">{{ music.title }}</p>
                    <p id="submitter_music" class="title_music_playlist">{{ music.submitter }}</p>
                    <a class="album_music_playlist" href="{% url 'album' music.album.id %}">{{ music.album.title }}</a>
                </button>

                <audio class="audio_{{ music.id }}" src="{{music.audio_file.url}}" type="audio/mp3"></audio>
            </li>
        {% endfor %}
    </ul>
    </div>
    <div class="info_music_play">
        <div class="info_song">
            <img id="cover">
            <div class="title_cover">
                <p id="title"></p>
                <p id="submitter"></p>
            </div>
        </div>
        <div class="control_audio">
            <input type="range" class="barre"  value="0">
            <div class="button_control_container">
                <button class="control_btn" onclick="playBefore()">
                    <svg width="30px" height="30px" viewBox="0 0 24 24" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
                        <g id="Page-1" stroke="none" stroke-width="1" fill="none" fill-rule="evenodd">
                            <g id="Prev">
                                <rect id="Rectangle" fill-rule="nonzero" x="0" y="0" width="24" height="24"></rect>
                                <path  d="M8.66288,12.4218 L18.2316,18.511 C18.5644,18.7228 19,18.4837 19,18.0892 L19,5.91084 C19,5.51629 18.5644,5.27718 18.2316,5.48901 L8.66288,11.5782 C8.35413,11.7746 8.35413,12.2254 8.66288,12.4218 Z" id="Path" stroke="#FFFFFF" stroke-width="2" stroke-linecap="round"></path>
                                <line x1="5" y1="5" x2="5" y2="19" id="Path" stroke="#FFFFFF" stroke-width="2" stroke-linecap="round"></line>
                            </g>
                        </g>
                    </svg>
                </button>
                <button class="control_btn" onclick="playAndPauseBis()">
                    <svg id="pause" fill="#FFFFFF" height="45px" width="45px" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
                         viewBox="0 0 512 512"  xml:space="preserve">
                        <path class="st0" d="M256,0C114.625,0,0,114.625,0,256c0,141.374,114.625,256,256,256s256-114.626,256-256
                            C512,114.625,397.375,0,256,0z M224,336h-64V176h64V336z M352,336h-64V176h64V336z"></path>
                    </svg>
                    <svg id="play" fill="#FFFFFF" height="45px" width="45px" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 512 512"  xml:space="preserve">
                        <g>
                            <path class="st0" d="M256,0C114.625,0,0,114.625,0,256c0,141.374,114.625,256,256,256c141.374,0,256-114.626,256-256
                                C512,114.625,397.374,0,256,0z M351.062,258.898l-144,85.945c-1.031,0.626-2.344,0.657-3.406,0.031
                                c-1.031-0.594-1.687-1.702-1.687-2.937v-85.946v-85.946c0-1.218,0.656-2.343,1.687-2.938c1.062-0.609,2.375-0.578,3.406,0.031
                                l144,85.962c1.031,0.586,1.641,1.718,1.641,2.89C352.703,257.187,352.094,258.297,351.062,258.898z"/>
                        </g>
                    </svg>
                </button>
                <button class="control_btn" onclick="playNext()">
                    <svg width="30px" height="30px" viewBox="0 0 24 24" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
                        <g id="Page-1" stroke="none" stroke-width="1" fill="none" fill-rule="evenodd">
                            <g id="Next">
                                <rect id="Rectangle" fill-rule="nonzero" x="0" y="0" width="24" height="24"></rect>
                                <path d="M15.3371,12.4218 L5.76844,18.511 C5.43558,18.7228 5,18.4837 5,18.0892 L5,5.91084 C5,5.51629 5.43558,5.27718 5.76844,5.48901 L15.3371,11.5782 C15.6459,11.7746 15.6459,12.2254 15.3371,12.4218 Z" id="Path" stroke="#FFFFFF" stroke-width="2" stroke-linecap="round"></path>
                                <line x1="19" y1="5" x2="19" y2="19" id="Path" stroke="#FFFFFF" stroke-width="2" stroke-linecap="round"></line>
                            </g>
                        </g>
                    </svg>
                </button>
            </div>
        </div>
        <div class="audio_volume">
            <svg fill="#FFFFFF" width="30px" height="30px" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" id="sound-max" class="icon glyph">
                <path d="M18.36,19.36a1,1,0,0,1-.7-.29,1,1,0,0,1,0-1.41,8,8,0,0,0,0-11.32,1,1,0,0,1,1.41-1.41,10,10,0,0,1,0,14.14A1,1,0,0,1,18.36,19.36Z" style="fill:#FFFFFF"></path>
                <path d="M15.54,16.54a1,1,0,0,1-.71-.3,1,1,0,0,1,0-1.41,4,4,0,0,0,0-5.66,1,1,0,0,1,1.41-1.41,6,6,0,0,1,0,8.48A1,1,0,0,1,15.54,16.54Z" style="fill:#FFFFFF"></path>
                <path d="M11.38,4.08a1,1,0,0,0-1.09.21L6.59,8H4a2,2,0,0,0-2,2v4a2,2,0,0,0,2,2H6.59l3.7,3.71A1,1,0,0,0,11,20a.84.84,0,0,0,.38-.08A1,1,0,0,0,12,19V5A1,1,0,0,0,11.38,4.08Z" style="fill:#FFFFFF"></path>
            </svg>
            <input type="range" id="volume" class="volume">
        </div>
    </div>
    <script>
        let audio = new Audio();
        let audio_play = new Audio();
        let current_song;
        let audio_id;

        let btn_play;
        let btn_pause;
        let btn_play_bis;
        let btn_pause_bis;

        let i_audio

        let percent;
        let cover
        let title
        let submitter

        let type;

        window.onload = function() {
            let listAudio = document.getElementsByTagName("audio");
            let listBtnPlay = document.getElementsByClassName("btn_play");
            let listBtnPause = document.getElementsByClassName("btn_pause");

            let listCoverAlbum = document.querySelectorAll("#cover_music");
            let listTitleMusic = document.querySelectorAll("#title_music");
            let listSubmitterMusic = document.querySelectorAll("#submitter_music");

            for (i_audio = 0; i_audio < listAudio.length; i_audio++) {

                listAudio[i_audio].setAttribute("id", i_audio);
                listBtnPlay[i_audio].setAttribute("id", "btn_play_" + (i_audio));
                listBtnPause[i_audio].setAttribute("id", "btn_pause_" + (i_audio));

                listCoverAlbum[i_audio].setAttribute("id", "cover_" + i_audio);
                listTitleMusic[i_audio].setAttribute("id", "title_" + i_audio);
                listSubmitterMusic[i_audio].setAttribute("id", "submitter_" + i_audio);
            }


        };
        let listAudio = document.getElementsByTagName("audio");

        audio = listAudio[current_song];
        let progress_barre = document.querySelector(".barre");
        let volume_bar = document.getElementById("volume");

        let btn_play_control = document.getElementById("play");
        let btn_pause_control = document.getElementById("pause");



        function playAndPauseBis(){
            if(audio.paused){
                btn_play.style.display = "none";
                btn_pause.style.display = "block";

                btn_play_control.style.display = "none"
                btn_pause_control.style.display = "block"

                audio.play()
                console.log(audio)
            }
            else{
                btn_play.style.display = "block";
                btn_pause.style.display = "none";

                btn_play_control.style.display = "block"
                btn_pause_control.style.display = "none"

                audio.pause()
            }
        }

        function playAndPause(audio_class) {
            current_song = null;
            audio = null

            audio = document.querySelector("." + audio_class);
            audio_id = audio.id;
            btn_play = document.getElementById("btn_play_" + audio_id);
            btn_pause = document.getElementById("btn_pause_" + audio_id);

            if (audio.paused) {
                for (current_song = 0; current_song<listAudio.length;){
                    audio_play = listAudio[current_song];
                    if(audio_play.paused === false){
                        audio_play.pause();
                         if(audio_play.played){
                         }
                        btn_play_bis = document.getElementById("btn_play_" + audio_play.id);
                        btn_pause_bis = document.getElementById("btn_pause_" + audio_play.id);

                        btn_play_bis.style.display = "block";
                        btn_pause_bis.style.display = "none";

                    }
                    current_song++;
                }

                audio.play();

                btn_play.style.display = "none";
                btn_pause.style.display = "block";

                btn_play_control.style.display = "none"
                btn_pause_control.style.display = "block"

                cover = document.getElementById("cover_" + audio.id);
                title = document.getElementById("title_" + audio.id);
                submitter = document.getElementById("submitter_" + audio.id);

                document.getElementById("cover").src = cover.src;
                document.getElementById("title").textContent = title.textContent;
                document.getElementById("submitter").textContent = submitter.textContent;



                progress_barre.addEventListener("input", function (){
                    percent = Math.trunc(audio.duration * (this.value/100));
                    audio.currentTime = Math.trunc(audio.duration * (this.value/100));
                })

                audio.addEventListener("timeupdate", function() {
                    percent = (audio.currentTime / audio.duration) * 100;
                    progress_barre.value = percent;
                })



                volume_bar.addEventListener("input", function() {
                    audio.volume = this.value / 100;
                })

                current_song = parseInt(audio.id);
                audio.addEventListener("ended", playNext);
            }

            else {
                audio.pause();
                btn_play.style.display = "block";
                btn_pause.style.display = "none";

                btn_play_control.style.display = "block"
                btn_pause_control.style.display = "none"
            }
        }

        function playNext() {
            audio.pause()
            audio.currentTime = 0;
            btn_play.style.display = "block";
            btn_pause.style.display = "none";

            current_song++;
            if (current_song >= listAudio.length) {
                current_song = 0;
            }
            audio = listAudio[current_song];

            btn_play = document.getElementById("btn_play_" + current_song);
            btn_pause = document.getElementById("btn_pause_" + current_song);

            btn_play.style.display = "none";
            btn_pause.style.display = "block";

            cover = document.getElementById("cover_" + audio.id);
            title = document.getElementById("title_" + audio.id);
            submitter = document.getElementById("submitter_" + audio.id);

            document.getElementById("cover").src = cover.src;
            document.getElementById("title").textContent = title.textContent;
            document.getElementById("submitter").textContent = submitter.textContent;

            audio.play();

            audio.addEventListener("timeupdate", function() {
                    percent = (audio.currentTime / audio.duration) * 100;
                    progress_barre.value = percent;
            })

            progress_barre.addEventListener("click", function (event){
                    audio.currentTime = audio.duration * ((event.clientX - this.offsetLeft) / this.offsetWidth);
            })

            volume_bar.addEventListener("input", function() {
                    audio.volume = this.value / 100;
            })

            audio.addEventListener("ended", playNext);
        }


        function playBefore() {
            audio.pause();
            audio.currentTime = 0;
            btn_play.style.display = "block";
            btn_pause.style.display = "none";

            current_song = current_song - 1;
            if (current_song <= 0) {
                current_song = listAudio.length - 1;
            }

            console.log(current_song)

            audio = listAudio[current_song];

            btn_play = document.getElementById("btn_play_" + current_song);
            btn_pause = document.getElementById("btn_pause_" + current_song);

            btn_play.style.display = "none";
            btn_pause.style.display = "block";

            cover = document.getElementById("cover_" + audio.id);
            title = document.getElementById("title_" + audio.id);
            submitter = document.getElementById("submitter_" + audio.id);

            document.getElementById("cover").src = cover.src;
            document.getElementById("title").textContent = title.textContent;
            document.getElementById("submitter").textContent = submitter.textContent;

            audio.play();

            audio.addEventListener("timeupdate", function () {
                percent = (audio.currentTime / audio.duration) * 100;
                progress_barre.value = percent;
            })

            progress_barre.addEventListener("click", function (event) {
                audio.currentTime = audio.duration * ((event.clientX - this.offsetLeft) / this.offsetWidth);
            })

            volume_bar.addEventListener("input", function () {
                audio.volume = this.value / 100;
            })

            audio.addEventListener("ended", playNext);
        }

    </script>
{% endblock %}
